<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khóa học: Kỹ thuật trồng lúa hiệu quả - Sổ tay nông dân</title>
    <link rel="stylesheet" href="styles/course-detail.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
</head>
<body class="glass-theme">
    <header class="main-header">
        <div class="container">
            <a href="dash.html" class="logo"><i class="fas fa-seedling"></i> Sổ Tay Nông Dân</a>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <article id="course-container" class="course-article card">
                
                <!-- VIEW 1: COURSE OVERVIEW -->
                <div id="course-overview">
                    <header class="course-header">
                        <h1>Khóa học: Kỹ thuật trồng lúa hiệu quả</h1>
                        <div class="course-meta">
                            <span class="meta-item"><i class="fas fa-user-tie"></i> Chuyên gia: GS.TS. Bùi Chí Bửu</span>
                            <span class="meta-item"><i class="fas fa-layer-group"></i> Lĩnh vực: Trồng trọt</span>
                            <span class="meta-item"><i class="fas fa-clock"></i> Thời lượng: 5 giờ</span>
                        </div>
                    </header>

                    <div class="course-image-container">
                        <img src="https://images.unsplash.com/photo-1560493676-04071c5f467b?q=80&w=1974&auto=format&fit=crop" alt="Cánh đồng lúa xanh mướt">
                    </div>

                    <div class="course-body">
                        <p class="sapo">
                            Khóa học này cung cấp kiến thức toàn diện từ cơ bản đến nâng cao về kỹ thuật canh tác lúa, giúp bà con nông dân tối ưu hóa năng suất, giảm chi phí và canh tác bền vững theo các tiêu chuẩn hiện đại.
                        </p>
                        
                        <div class="progress-tracker">
                            <h3>Tiến độ khóa học</h3>
                            <div class="progress-bar-container">
                                <div id="course-progress-bar" class="progress-bar"></div>
                            </div>
                            <span id="progress-text">0/4 chương hoàn thành</span>
                        </div>

                        <h2>Nội dung khóa học</h2>
                        <div id="accordion-container" class="accordion">
                            <!-- Accordion items will be generated by JS -->
                        </div>

                        <div id="login-prompt-container" class="view-hidden" style="text-align: center; margin-top: 20px;">
                            <p><a href="login.html">Đăng nhập</a> để theo dõi tiến độ học tập của bạn.</p>
                        </div>

                        <div class="quiz-cta card">
                            <h3>Kiểm tra kiến thức của bạn!</h3>
                            <p>Sau khi hoàn thành khóa học, hãy làm bài kiểm tra để củng cố kiến thức và nhận chứng chỉ.</p>
                            <a href="quiz.html" class="btn btn-primary">Làm bài kiểm tra ngay</a>
                        </div>
                    </div>
                </div>

                <!-- VIEW 2: LESSON VIEW (Initially Hidden) -->
                <div id="lesson-view" class="view-hidden">
                    <div class="lesson-breadcrumb">
                         <button id="back-to-overview-btn">Tổng quan khóa học</button> > <span id="breadcrumb-chapter"></span> > <span id="breadcrumb-lesson"></span>
                    </div>
                    <h2 id="lesson-title"></h2>
                    <div id="lesson-content"></div>
                    <div class="lesson-navigation">
                        <button id="mark-lesson-complete" class="btn">
                            <i class="fas fa-check"></i>
                            <i class="fas fa-circle-notch"></i>
                            <span>Đánh dấu đã học xong</span>
                        </button>
                        <div class="nav-buttons">
                            <button id="prev-lesson-btn" class="btn btn-secondary btn-lesson-nav"><i class="fas fa-arrow-left"></i> Bài trước</button>
                            <button id="next-lesson-btn" class="btn btn-primary btn-lesson-nav">Bài tiếp theo <i class="fas fa-arrow-right"></i></button>
                        </div>
                    </div>
                </div>

            </article>
        </div>
    </main>

    <footer class="main-footer">
        <div class="container">
            <p>&copy; 2025 Sổ tay nông dân thông minh. Mọi quyền được bảo lưu.</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- DATA ---
            const courseId = 'rice-course-v1';
            const courseData = [
                {
                    title: "Chuẩn bị đất và chọn giống",
                    lessons: [
                        { id: 'c0l0', title: "Phân tích và cải tạo đất", content: "<h3>Tại sao cần phân tích đất?</h3><p>Phân tích đất giúp xác định độ pH, hàm lượng hữu cơ, và các chất dinh dưỡng đa, trung, vi lượng. Từ đó, ta có thể đưa ra biện pháp cải tạo phù hợp, tránh bón phân thừa hoặc thiếu.</p><h3>Các bước cải tạo đất cơ bản:</h3><ul><li>Đối với đất phèn: Bón vôi để nâng pH, kết hợp rửa phèn bằng nước ngọt.</li><li>Đối với đất mặn: Xây dựng hệ thống kênh mương để rửa mặn, trồng các giống cây chịu mặn.</li><li>Đối với đất bạc màu: Tăng cường bón phân hữu cơ, phân chuồng ủ hoai để bổ sung mùn và vi sinh vật.</li></ul>" },
                        { id: 'c0l1', title: "Phương pháp làm đất hiện đại", content: "<h3>Làm đất tối thiểu:</h3><p>Phương pháp này hạn chế xới lật đất, chỉ làm đất trên hàng gieo trồng. Giúp giữ cấu trúc đất, chống xói mòn và giữ ẩm.</p><h3>San phẳng mặt ruộng bằng laser:</h3><p>Sử dụng công nghệ laser giúp mặt ruộng bằng phẳng tuyệt đối. Lợi ích: tiết kiệm nước tưới, lúa sinh trưởng đồng đều, giảm cỏ dại, dễ dàng cơ giới hóa.</p>" },
                        { id: 'c0l2', title: "Lựa chọn giống lúa", content: "<h3>Tiêu chí chọn giống:</h3><ul><li>Phù hợp với điều kiện khí hậu, thổ nhưỡng của địa phương.</li><li>Khả năng chống chịu sâu bệnh tốt.</li><li>Thời gian sinh trưởng phù hợp với khung thời vụ.</li><li>Năng suất cao, chất lượng gạo tốt, đáp ứng thị hiệu thị trường.</li></ul><p>Ví dụ: Vùng Đồng bằng sông Cửu Long thường chuộng các giống như OM5451, Đài Thơm 8...</p>" }
                    ]
                },
                {
                    title: "Kỹ thuật gieo sạ và cấy",
                    lessons: [
                        { id: 'c1l0', title: "Ngâm ủ và xử lý hạt giống", content: "<h3>Mục đích:</h3><p>Giúp hạt giống nảy mầm đều và khỏe, loại bỏ mầm bệnh tồn tại trên vỏ hạt.</p><h3>Các bước thực hiện:</h3><ul><li>Phơi lại hạt giống dưới nắng nhẹ 2-3 giờ.</li><li>Ngâm hạt trong nước sạch 24-36 giờ.</li><li>Vớt ra, rửa sạch và ủ trong bao tải hoặc thúng có lót rơm, giữ ẩm. Sau 24-36 giờ ủ, rễ và mầm sẽ nhú ra đều.</li></ul>" },
                        { id: 'c1l1', title: "Kỹ thuật gieo sạ tiên tiến", content: "<h3>Sạ hàng:</h3><p>Sử dụng giàn sạ kéo tay hoặc máy để gieo lúa theo hàng. Giúp tiết kiệm giống, lúa thông thoáng, dễ chăm sóc và quang hợp tốt.</p><h3>Sạ cụm:</h3><p>Sử dụng máy sạ cụm để gieo lúa theo từng cụm với khoảng cách đều nhau. Đây là kỹ thuật tiên tiến giúp giảm lượng giống tối đa, tạo không gian cho lúa phát triển.</p>" },
                        { id: 'c1l2', title: "So sánh Cấy và Sạ", content: "<h3>Ưu điểm của Cấy:</h3><ul><li>Tiết kiệm giống.</li><li>Ruộng lúa thông thoáng, ít sâu bệnh.</li><li>Chủ động thời gian, né rầy.</li></ul><h3>Nhược điểm của Cấy:</h3><ul><li>Tốn nhiều công lao động.</li><li>Chi phí cao hơn.</li></ul><h3>Ưu điểm của Sạ:</h3><ul><li>Nhanh, đỡ tốn công.</li><li>Chi phí thấp.</li></ul><h3>Nhược điểm của Sạ:</h3><ul><li>Tốn nhiều giống hơn.</li><li>Lúa mọc dày, dễ bị sâu bệnh nếu quản lý không tốt.</li></ul>" }
                    ]
                },
                // Add other chapters similarly...
                { title: "Quản lý dinh dưỡng và nước tưới", lessons: [{id: 'c2l0', title: 'Bài 1'}, {id: 'c2l1', title: 'Bài 2'}, {id: 'c2l2', title: 'Bài 3'}] },
                { title: "Quản lý dịch hại tổng hợp (IPM)", lessons: [{id: 'c3l0', title: 'Bài 1'}, {id: 'c3l1', title: 'Bài 2'}, {id: 'c3l2', title: 'Bài 3'}] }
            ];

            // --- DOM ELEMENTS ---
            const courseContainer = document.getElementById('course-container');
            const overviewView = document.getElementById('course-overview');
            const lessonView = document.getElementById('lesson-view');
            const accordionContainer = document.getElementById('accordion-container');
            const progressBar = document.getElementById('course-progress-bar');
            const progressText = document.getElementById('progress-text');
            const loginPromptContainer = document.getElementById('login-prompt-container');
            const backToOverviewBtn = document.getElementById('back-to-overview-btn');
            const lessonTitle = document.getElementById('lesson-title');
            const lessonContent = document.getElementById('lesson-content');
            const markLessonCompleteBtn = document.getElementById('mark-lesson-complete');
            const prevLessonBtn = document.getElementById('prev-lesson-btn');
            const nextLessonBtn = document.getElementById('next-lesson-btn');
            const breadcrumbChapter = document.getElementById('breadcrumb-chapter');
            const breadcrumbLesson = document.getElementById('breadcrumb-lesson');

            // --- STATE ---
            let currentUser = null;
            let progressData = {}; // { 'c0l0': true, 'c0l1': false, ... }
            let currentChapterIndex = -1;
            let currentLessonIndex = -1;

            // --- FUNCTIONS ---

            function saveData() {
                if (!currentUser) return;
                localStorage.setItem(`${courseId}_${currentUser.id}_progress`, JSON.stringify(progressData));
            }

            function loadData() {
                const userData = localStorage.getItem("currentUser");
                if (userData) {
                    currentUser = JSON.parse(userData);
                    const savedProgress = localStorage.getItem(`${courseId}_${currentUser.id}_progress`);
                    if (savedProgress) {
                        progressData = JSON.parse(savedProgress);
                    }
                }
            }

            function renderOverview() {
                overviewView.classList.remove('view-hidden');
                lessonView.classList.add('view-hidden');
                
                accordionContainer.innerHTML = '';
                let completedChapters = 0;

                courseData.forEach((chapter, chapterIndex) => {
                    const lessonsInChapter = chapter.lessons;
                    let lessonsHTML = '<ul>';
                    let completedLessonsInChapter = 0;

                    lessonsInChapter.forEach(lesson => {
                        const isCompleted = progressData[lesson.id] === true;
                        if (isCompleted) completedLessonsInChapter++;
                        lessonsHTML += `
                            <li>
                                <span>${lesson.title}</span>
                                <i class="fas ${isCompleted ? 'fa-check-circle' : 'fa-circle'} lesson-status-icon ${isCompleted ? 'completed' : ''}"></i>
                            </li>`;
                    });
                    lessonsHTML += '</ul>';

                    if (completedLessonsInChapter === lessonsInChapter.length && lessonsInChapter.length > 0) {
                        completedChapters++;
                    }

                    const accordionItem = document.createElement('div');
                    accordionItem.className = 'accordion-item';
                    accordionItem.innerHTML = `
                        <button class="accordion-header">
                            <span>Chương ${chapterIndex + 1}: ${chapter.title}</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="accordion-content">
                            <div class="content-inner">
                                ${lessonsHTML}
                                <div class="btn-start-chapter">
                                    <button class="btn btn-secondary btn-start" data-chapter="${chapterIndex}">Bắt đầu chương học</button>
                                </div>
                            </div>
                        </div>`;
                    accordionContainer.appendChild(accordionItem);
                });

                // Update overall progress bar
                const totalChapters = courseData.length;
                const progressPercentage = totalChapters > 0 ? (completedChapters / totalChapters) * 100 : 0;
                progressBar.style.width = `${progressPercentage}%`;
                progressText.textContent = `${completedChapters}/${totalChapters} chương hoàn thành`;
                
                // Show/hide login prompt
                loginPromptContainer.classList.toggle('view-hidden', !!currentUser);

                // Add event listeners for new elements
                document.querySelectorAll('.accordion-header').forEach(header => {
                    header.addEventListener('click', () => {
                        const content = header.nextElementSibling;
                        header.classList.toggle('active');
                        content.style.maxHeight = header.classList.contains('active') ? content.scrollHeight + "px" : null;
                    });
                });

                document.querySelectorAll('.btn-start').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const chapterIndex = parseInt(e.target.dataset.chapter);
                        startChapter(chapterIndex);
                    });
                });
            }

            function renderLesson(chapterIndex, lessonIndex) {
                currentChapterIndex = chapterIndex;
                currentLessonIndex = lessonIndex;

                overviewView.classList.add('view-hidden');
                lessonView.classList.remove('view-hidden');
                
                const chapter = courseData[chapterIndex];
                const lesson = chapter.lessons[lessonIndex];
                
                // Update breadcrumb
                breadcrumbChapter.textContent = `Chương ${chapterIndex + 1}`;
                breadcrumbLesson.textContent = lesson.title;

                // Update lesson content
                lessonTitle.textContent = lesson.title;
                lessonContent.innerHTML = lesson.content || "<p>Nội dung đang được cập nhật.</p>";
                
                // Update completion button
                const isCompleted = progressData[lesson.id] === true;
                markLessonCompleteBtn.classList.toggle('completed', isCompleted);
                markLessonCompleteBtn.querySelector('span').textContent = isCompleted ? 'Đã hoàn thành' : 'Đánh dấu đã học xong';
                markLessonCompleteBtn.disabled = !currentUser;


                // Update navigation buttons
                prevLessonBtn.disabled = (chapterIndex === 0 && lessonIndex === 0);
                
                const isLastLessonInCourse = (chapterIndex === courseData.length - 1 && lessonIndex === chapter.lessons.length - 1);
                nextLessonBtn.disabled = isLastLessonInCourse;
                if (lessonIndex === chapter.lessons.length - 1) {
                    nextLessonBtn.innerHTML = 'Chương tiếp theo <i class="fas fa-arrow-right"></i>';
                } else {
                    nextLessonBtn.innerHTML = 'Bài tiếp theo <i class="fas fa-arrow-right"></i>';
                }

                window.scrollTo(0, 0);
            }
            
            function startChapter(chapterIndex) {
                if(courseData[chapterIndex] && courseData[chapterIndex].lessons.length > 0) {
                    renderLesson(chapterIndex, 0);
                } else {
                    alert('Chương này hiện chưa có bài học.');
                }
            }
            
            function handleMarkComplete() {
                if (!currentUser) {
                    alert('Vui lòng đăng nhập để lưu tiến độ.');
                    return;
                }
                const lesson = courseData[currentChapterIndex].lessons[currentLessonIndex];
                progressData[lesson.id] = true;
                saveData();
                renderLesson(currentChapterIndex, currentLessonIndex); // Re-render to update button state
            }

            function handleNavigation(direction) {
                let nextLesson = currentLessonIndex;
                let nextChapter = currentChapterIndex;

                if (direction === 'next') {
                    if (currentLessonIndex < courseData[currentChapterIndex].lessons.length - 1) {
                        nextLesson++;
                    } else if (currentChapterIndex < courseData.length - 1) {
                        nextChapter++;
                        nextLesson = 0;
                    }
                } else if (direction === 'prev') {
                    if (currentLessonIndex > 0) {
                        nextLesson--;
                    } else if (currentChapterIndex > 0) {
                        nextChapter--;
                        nextLesson = courseData[nextChapter].lessons.length - 1;
                    }
                }
                renderLesson(nextChapter, nextLesson);
            }


            // --- EVENT LISTENERS ---
            backToOverviewBtn.addEventListener('click', renderOverview);
            markLessonCompleteBtn.addEventListener('click', handleMarkComplete);
            prevLessonBtn.addEventListener('click', () => handleNavigation('prev'));
            nextLessonBtn.addEventListener('click', () => handleNavigation('next'));


            // --- INITIALIZATION ---
            function init() {
                loadData();
                renderOverview();
            }

            init();
        });
    </script>
</body>
</html>
